#!/bin/bash

set -e

# è®¾ç½®è‡ªèº«å¯æ‰§è¡Œæƒé™ï¼ˆå¦‚æœªæå‰è®¾ç½®ï¼‰
chmod +x "$0"

# æ£€æŸ¥æ˜¯å¦ä¸º root ç”¨æˆ·
if [ "$(id -u)" -ne 0 ]; then
  echo "âŒ è¯·ä½¿ç”¨ root ç”¨æˆ·è¿è¡Œæ­¤è„šæœ¬ã€‚"
  exit 1
fi

# è¯»å–åŸºæœ¬å‚æ•°
read -p "è¯·è¾“å…¥ç»Ÿä¸€çš„ç«¯å£å·ï¼ˆä¾‹å¦‚1080ï¼‰: " PORT
read -p "è¯·è¾“å…¥ç”¨æˆ·å: " USER
read -s -p "è¯·è¾“å…¥å¯†ç : " PASS
echo ""

# æ£€æŸ¥ IPv4 åœ°å€æ•°é‡ï¼ˆä¸å« 127.0.0.1ï¼‰
REAL_IPS=( $(ip -4 addr show | grep -oP '(?<=inet\s)\d+(\.\d+){3}' | grep -v '^127\.') )
if [ ${#REAL_IPS[@]} -le 1 ]; then
  echo -e "\nğŸ§© å½“å‰ä»…æ£€æµ‹åˆ°ä¸€ä¸ªå…¬ç½‘ IPv4 åœ°å€ã€‚è¯·è¾“å…¥è¦ç»‘å®šçš„é¢å¤– IP åœ°å€ï¼ˆæ¯è¡Œä¸€ä¸ªï¼Œè¾“å…¥ç©ºè¡Œç»“æŸï¼‰ï¼š"
  IP_LIST_INPUT=()
  while true; do
    read -p "> " ip
    [[ -z "$ip" ]] && break
    IP_LIST_INPUT+=("$ip")
  done

  # è·å–ä¸»ç½‘å¡å
  IFACE=$(ip -o -4 route show to default | awk '{print $5}')
  echo "\nğŸ”— æ£€æµ‹åˆ°ä¸»ç½‘å¡: $IFACE"

  # å¤‡ä»½åŸå§‹é…ç½®
  cp /etc/network/interfaces /etc/network/interfaces.bak.$(date +%s)

  # æ·»åŠ ç»‘å®š
  for ((i=0; i<${#IP_LIST_INPUT[@]}; i++)); do
    echo "auto $IFACE:$i" >> /etc/network/interfaces
    echo "iface $IFACE:$i inet static" >> /etc/network/interfaces
    echo "  address ${IP_LIST_INPUT[$i]}" >> /etc/network/interfaces
    echo "  netmask 255.255.255.255" >> /etc/network/interfaces
    echo "" >> /etc/network/interfaces
  done

  echo -e "\nğŸ’¡ å·²å†™å…¥ /etc/network/interfacesï¼Œæ­£åœ¨é‡å¯ç½‘ç»œæœåŠ¡ä»¥ç”Ÿæ•ˆ..."
  systemctl restart networking
  sleep 3
fi

# å†æ¬¡æ”¶é›†æœ¬æœºæ‰€æœ‰é127 IPv4
IP_LIST=$(ip -4 addr show | grep -oP '(?<=inet\s)\d+(\.\d+){3}' | grep -v '^127\.' | sort -u)

# å®‰è£…ä¾èµ–
echo -e "\nğŸ”„ æ­£åœ¨æ›´æ–°ç³»ç»Ÿå¹¶å®‰è£…ä¾èµ–..."
apt update && apt upgrade -y
apt install -y curl unzip jq net-tools iptables iptables-persistent

# ä¸‹è½½å¹¶å®‰è£… Xray Core
XRAY_DIR="/usr/local/xray"
XRAY_ZIP_URL="https://github.com/XTLS/Xray-core/releases/latest/download/Xray-linux-64.zip"
mkdir -p "$XRAY_DIR"
cd "$XRAY_DIR"
curl -L -o xray.zip "$XRAY_ZIP_URL"
unzip -o xray.zip
chmod +x xray
rm -f xray.zip

# æ„å»º Xray é…ç½®
CONFIG_FILE="$XRAY_DIR/config.json"
echo -e "\nâš™ï¸ æ­£åœ¨ç”Ÿæˆ Xray é…ç½®æ–‡ä»¶..."
echo '{' > "$CONFIG_FILE"
echo '  "log": { "loglevel": "warning" },' >> "$CONFIG_FILE"
echo '  "inbounds": [' >> "$CONFIG_FILE"

INDEX=0
IP_ARR=()
for IP in $IP_LIST; do
  IP_ARR+=("$IP")
  cat >> "$CONFIG_FILE" <<EOF
    {
      "tag": "socks_$INDEX",
      "port": $PORT,
      "listen": "$IP",
      "protocol": "socks",
      "settings": {
        "auth": "password",
        "accounts": [
          { "user": "$USER", "pass": "$PASS" }
        ],
        "udp": true
      }
    },
EOF
  ((INDEX++))
done

# æ¸…ç†æœ€åä¸€ä¸ªé€—å·
sed -i '$ s/},/}/' "$CONFIG_FILE"
echo '  ],' >> "$CONFIG_FILE"
echo '  "outbounds": [' >> "$CONFIG_FILE"
echo '    { "protocol": "freedom" }' >> "$CONFIG_FILE"
echo '  ]' >> "$CONFIG_FILE"
echo '}' >> "$CONFIG_FILE"

# æ”¾è¡Œç«¯å£
echo -e "\nğŸ“¶ æ”¾è¡Œç«¯å£ $PORT ..."
iptables -I INPUT -p tcp --dport "$PORT" -j ACCEPT
iptables -I INPUT -p udp --dport "$PORT" -j ACCEPT

# ä¿å­˜è§„åˆ™
echo -e "ğŸ’¾ ä¿å­˜ iptables è§„åˆ™..."
netfilter-persistent save

# åˆ›å»º systemd æœåŠ¡
echo -e "ğŸ§© åˆ›å»ºå¹¶å¯åŠ¨ Xray systemd æœåŠ¡..."
cat > /etc/systemd/system/xray.service <<EOF
[Unit]
Description=Xray Service
After=network.target

[Service]
Type=simple
ExecStart=$XRAY_DIR/xray -config $XRAY_DIR/config.json
Restart=on-failure

[Install]
WantedBy=multi-user.target
EOF

systemctl daemon-reexec
systemctl daemon-reload
systemctl enable xray
systemctl restart xray

# æ‰“å°è¿æ¥ä¿¡æ¯
echo -e "\nâœ… Xray SOCKS5 å¤šIPä»£ç†å·²éƒ¨ç½²æˆåŠŸï¼"
echo "ç›‘å¬ IP åˆ—è¡¨ï¼š"
for ip in "${IP_ARR[@]}"; do
  echo "  - $ip"
done

echo -e "\nè¿æ¥ä¿¡æ¯ï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰ï¼š"
for ip in "${IP_ARR[@]}"; do
  echo "$ip:$PORT ç”¨æˆ·å: $USER å¯†ç : $PASS"
done

echo -e "\nè¯·ç¡®ä¿å®¢æˆ·ç«¯è¿æ¥æ—¶ä½¿ç”¨å¯¹åº”IPå’Œç«¯å£ï¼Œå¹¶è¾“å…¥æ­£ç¡®çš„ç”¨æˆ·åå’Œå¯†ç ã€‚"
