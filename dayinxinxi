#!/bin/bash

set -e

if [ "$(id -u)" -ne 0 ]; then
  echo "âŒ è¯·ä½¿ç”¨ root ç”¨æˆ·è¿è¡Œæ­¤è„šæœ¬ã€‚"
  exit 1
fi

read -p "è¯·è¾“å…¥ç»Ÿä¸€çš„ç«¯å£å·ï¼ˆä¾‹å¦‚1080ï¼‰: " PORT
read -p "è¯·è¾“å…¥ç”¨æˆ·å: " USER
read -s -p "è¯·è¾“å…¥å¯†ç : " PASS
echo ""

echo -e "\nğŸ”„ å®‰è£…ä¾èµ–..."
apt update && apt install -y curl unzip jq iptables iptables-persistent net-tools

XRAY_DIR="/usr/local/xray"
XRAY_BIN="$XRAY_DIR/xray"
CONFIG="$XRAY_DIR/config.json"

mkdir -p "$XRAY_DIR"
cd "$XRAY_DIR"

echo "â¬‡ï¸ ä¸‹è½½ Xray..."
curl -L -o xray.zip https://github.com/XTLS/Xray-core/releases/latest/download/Xray-linux-64.zip
unzip -o xray.zip && rm xray.zip
chmod +x xray

echo "ğŸ“¡ è·å– IP åˆ—è¡¨..."
IP_LIST=($(ip -4 addr show | grep -oP '(?<=inet\s)\d+(\.\d+){3}' | grep -v '^127\.' | sort -u))

echo "âš™ï¸ ç”Ÿæˆé…ç½®..."
INBOUND_JSON=""
OUTBOUND_JSON=""
ROUTE_RULES=""

for i in "${!IP_LIST[@]}"; do
  IP="${IP_LIST[$i]}"

  INBOUND_JSON+=$(cat <<EOF
{
  "tag": "socks_$i",
  "port": $PORT,
  "listen": "$IP",
  "protocol": "socks",
  "settings": {
    "auth": "password",
    "accounts": [{ "user": "$USER", "pass": "$PASS" }],
    "udp": true
  },
  "sniffing": {
    "enabled": true,
    "destOverride": ["http", "tls"]
  }
},
EOF
)

  OUTBOUND_JSON+=$(cat <<EOF
{
  "tag": "out_$i",
  "protocol": "freedom",
  "settings": {},
  "sendThrough": "$IP"
},
EOF
)

  ROUTE_RULES+=$(cat <<EOF
{
  "type": "field",
  "inboundTag": ["socks_$i"],
  "outboundTag": "out_$i"
},
EOF
)
done

# å»é™¤å°¾éƒ¨é€—å·
INBOUND_JSON=$(echo "$INBOUND_JSON" | sed '$ s/},/}/')
OUTBOUND_JSON=$(echo "$OUTBOUND_JSON" | sed '$ s/},/}/')
ROUTE_RULES=$(echo "$ROUTE_RULES" | sed '$ s/},/}/')

cat > "$CONFIG" <<EOF
{
  "log": { "loglevel": "warning" },
  "inbounds": [
$INBOUND_JSON
  ],
  "outbounds": [
$OUTBOUND_JSON
  ],
  "routing": {
    "domainStrategy": "AsIs",
    "rules": [
$ROUTE_RULES
    ]
  }
}
EOF

echo "âœ… éªŒè¯é…ç½®æ–‡ä»¶..."
if ! $XRAY_BIN -test -config "$CONFIG"; then
  echo "âŒ é…ç½®æ–‡ä»¶æœ‰è¯¯ï¼Œç»ˆæ­¢æ‰§è¡Œã€‚"
  exit 1
fi

echo "ğŸ“¶ æ”¾è¡Œç«¯å£ $PORT ..."
iptables -I INPUT -p tcp --dport "$PORT" -j ACCEPT
iptables -I INPUT -p udp --dport "$PORT" -j ACCEPT
netfilter-persistent save

echo "ğŸ”§ åˆ›å»º systemd æœåŠ¡..."
cat > /etc/systemd/system/xray.service <<EOF
[Unit]
Description=Xray Service
After=network.target

[Service]
ExecStart=$XRAY_BIN -config $CONFIG
Restart=on-failure
User=root

[Install]
WantedBy=multi-user.target
EOF

systemctl daemon-reload
systemctl enable xray
systemctl restart xray

echo -e "\nâœ… Xray å·²éƒ¨ç½²æˆåŠŸï¼è¿æ¥ä¿¡æ¯ï¼š"
for ip in "${IP_LIST[@]}"; do
  echo "$ip:$PORT ç”¨æˆ·å: $USER å¯†ç : $PASS"
done
